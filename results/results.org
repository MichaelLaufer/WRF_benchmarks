#+TITLE: WRF scaling and timing on Cheyenne
#+AUTHOR: Akira Kyle
#+EMAIL: akyle@cmu.edu
#+OPTIONS: toc:nil email:t
#+PROPERTY: header-args :results raw drawer :exports both

* Code Snippets
  :PROPERTIES:
  :header-args: :results silent :exports code
  :END:

#+begin_src ipython :session
import numpy as np
import matplotlib.pyplot as plt
%matplotlib inline
%config InlineBackend.figure_format = 'svg'
#+end_src

#+begin_src ipython :session
def plot_it(cases, labels, title):
    for case,label in zip(cases,labels):
        runs = getFromDict(data, case)
        sec_step = np.array([d[2] for _,d in runs.items() if d[2] != '--'])
        cpus = np.array([d[7] for _,d in runs.items() if d[2] != '--'])
        gridpoints = e_we[case[0]] * e_sn[case[0]]
        plt.loglog(gridpoints/cpus, 1/sec_step, '+--', label=label[0])
    plt.xlabel("Total grid points / core")
    plt.ylabel("Time steps / s")
    plt.legend(loc='upper center', bbox_to_anchor=(1.35, 0.8), ncol=1)
    #plt.legend(loc='upper center', bbox_to_anchor=(0.5, -0.05), ncol=2)
    plt.title(title)
    plt.grid(False)
#+end_src

#+begin_src ipython :session :var raw_data=data.org:data raw_gridpoints=data.org:gridpoints
from collections import defaultdict
from functools import reduce
from operator import getitem

def getFromDict(dataDict, mapList): return reduce(getitem, mapList, dataDict)
tree = lambda: defaultdict(tree)

data = tree()
for run in raw_data:
    keys = run[0].split('/')[1:]
    keys[-1] = int(keys[-1][1:-4])
    keys[-2] = int(keys[-2][1:])
    d = getFromDict(data,keys[:-1])
    d[keys[-1]] = run[1:]

e_we = {}
e_sn = {}
for case in raw_gridpoints:
    e_we[case[0]] = case[1]
    e_sn[case[0]] = case[2]
#+end_src

* CONUS 12km

#+begin_src sh :eval no
wrf_run_pbs_jobs \
    --wrfs ~/work/WRFs/WRFV3.8.1-gnu6.3.0-mpt2.18 \
    --cases ~/WRF_benchmarks/cases/conus12km \
    -n 1 2 4 8 16 32 64 128 256 -t 1
wrf_summarize_runs -r conus12km-WRFV3.8.1-gnu6.3.0-mpt2.18-T1-N* \
                   -o conus12km-WRFV3.8.1/gnu6.3.0/mpt2.18/T1 -t
#+end_src

#+name: conus12km-cases
| case      | WRF version | compiler    | mpi                | trial |
|-----------+-------------+-------------+--------------------+-------|
| conus12km | WRFV3.8.1   | gnu6.3.0    | mpt2.18            |     1 |
| conus12km | WRFV3.8.1   | gnu6.3.0    | mpt2.18            |     2 |
| conus12km | WRFV3.8.1   | gnu6.3.0    | mvapich2.2         |     1 |
| conus12km | WRFV3.8.1   | gnu6.3.0    | mvapich2.2         |     2 |
| conus12km | WRFV3.8.1   | gnu6.3.0    | mvapich2.2gnu7.1.0 |     1 |
| conus12km | WRFV3.8.1   | gnu6.3.0    | mvapich2.2gnu7.1.0 |     2 |
| conus12km | WRFV3.8.1   | intel18.0.1 | mpt2.18            |     1 |
| conus12km | WRFV3.8.1   | intel18.0.1 | mpt2.18            |     2 |

#+name: conus12km-labels
| label                          |
|--------------------------------|
| gnu6.3.0/mpt2.18/T1            |
| gnu6.3.0/mpt2.18/T2            |
| gnu6.3.0/mvapich2.2/T1         |
| gnu6.3.0/mvapich2.2/T2         |
| gnu6.3.0/mvapich2.2gnu7.1.0/T1 |
| gnu6.3.0/mvapich2.2gnu7.1.0/T2 |
| intel18.0.1/mpt2.18/T1         |
| intel18.0.1/mpt2.18/T2         |

#+header: :var cases=conus12km-cases labels=conus12km-labels
#+header: :var title="Scaling results for CONUS 12km with WRFV3.8.1"
#+begin_src ipython :session
plot_it(cases, labels, title)
#+end_src

#+RESULTS:
:RESULTS:
# Out[13]:
[[file:./obipy-resources/zA90Fi.svg]]
:END:

* NEW CONUS 12km
#+begin_src sh :eval no
wrf_run_pbs_jobs \
    --wrfs \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-fma-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-O3-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-O3-fma-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-intel17.0.1-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-intel18.0.1-mvapich2.2 \
    --cases ~/WRF_benchmarks/cases/new_conus12km \
    -n 1 2 4 8 16 -t 1

wrf_summarize_runs -r conus12km-WRFV3.8.1-gnu6.3.0-mpt2.18-T1-N* \
                   -o conus12km-WRFV3.8.1/gnu6.3.0/mpt2.18/T1 -t
#+end_src

#+name: new_conus12km-cases
| case          | WRF version | compiler    | mpi     | trial |
|---------------+-------------+-------------+---------+-------|
| new_conus12km | WRFV4.0     | gnu6.3.0    | mpt2.18 |     1 |
| new_conus12km | WRFV4.0     | intel18.0.1 | mpt2.18 |     1 |
| new_conus12km | WRFV4.0     | intel18.0.1 | mpt2.18 |     2 |

#+name: new_conus12km-labels
| label                  |
|------------------------|
| gnu6.3.0/mpt2.18/T1    |
| intel18.0.1/mpt2.18/T1 |
| intel18.0.1/mpt2.18/T2 |

#+header: :var cases=new_conus12km-cases labels=new_conus12km-labels
#+header: :var title="Scaling results for CONUS 12km with WRFV3.8.1"
#+begin_src ipython :session :results raw drawer :exports both
plot_it(cases, labels, title)
#+end_src

#+RESULTS:
:RESULTS:
# Out[14]:
[[file:./obipy-resources/m8I4Os.svg]]
:END:

* NEW CONUS 2.5km

#+begin_src sh :eval no

wrf_run_pbs_jobs \
    --wrfs \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-fma-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-O3-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-O3-fma-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-intel17.0.1-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-intel18.0.1-mvapich2.2 \
    --cases ~/WRF_benchmarks/cases/new_conus12km \
    -n 1 2 4 8 16 -t 1


wrf_run_pbs_jobs \
    --wrfs \
    ~/work/WRFs/WRFV4.0-intel17.0.1-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-intel18.0.1-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu6.3.0-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-O3-fma-mvapich2.2 \
    ~/work/WRFs/WRFV4.0-gnu8.1.0-mpt2.18 \
    --cases \
    ~/WRF_benchmarks/cases/new_conus2.5km \
    ~/WRF_benchmarks/cases/maria3km \
    ~/WRF_benchmarks/cases/maria1km \
    -n 1 2 4 8 16 32 64 128 256 -t 2 -a '04:00:00'

wrf_summarize_runs -r conus12km-WRFV3.8.1-gnu6.3.0-mpt2.18-T1-N* \
                   -o conus12km-WRFV3.8.1/gnu6.3.0/mpt2.18/T1 -t
#+end_src

* Cases

#+name: cases-cases
| case           | WRF version | compiler | mpi        | trial |
|----------------+-------------+----------+------------+-------|
| new_conus12km  | WRFV4.0     | gnu8.1.0 | mpt2.18    |     1 |
| new_conus12km  | WRFV4.0     | gnu8.1.0 | mvapich2.2 |     1 |
| new_conus2.5km | WRFV4.0     | gnu8.1.0 | mpt2.18    |     1 |
| new_conus2.5km | WRFV4.0     | gnu8.1.0 | mvapich2.2 |     1 |
| maria3km       | WRFV4.0     | gnu8.1.0 | mpt2.18    |     1 |
| maria3km       | WRFV4.0     | gnu8.1.0 | mvapich2.2 |     1 |

#+name: cases-labels
| label                     |
|---------------------------|
| new_conus12km/mpt2.18     |
| new_conus12km/mvapich2.2  |
| new_conus2.5km/mpt2.18    |
| new_conus2.5km/mvapich2.2 |
| maria3km/mpt2.18          |
| maria3km/mvapich2.2       |

#+header: :var cases=cases-cases labels=cases-labels
#+header: :var title="Scaling results for CONUS 12km with WRFV3.8.1"
#+begin_src ipython :session
plot_it(cases, labels, title)
#+end_src

#+RESULTS:
:RESULTS:
# Out[15]:
[[file:./obipy-resources/6PTkk1.svg]]
:END:
