#!/bin/sh

help() {
    echo ""
    echo "Usage: ${0##*/} [OPTIONS]"
    echo "Analyzes timing output info for WRF runs"
    echo ""
    echo "OPTIONS:"
    echo "    -a, --all                 Includes all timesteps, including those involving disk I/O"
    echo "    -f, --files RSL1 RSL2 ... Specifies a space-delimited list of output files containing timing info"
    echo "    -s, --timestep TSTEP      Use TSTEP (seconds) to compute speed"
    echo "    -h, --help                This help"
    echo ""
    exit 0
}

reading_list=false
filter=2

while test $# -gt 0
do
    case $1 in
        -f|--files)
            reading_files=true
	          shift ;;
        -a|--all)
            filter=1
            reading_files=false
	          shift ;;
        -s|--timestep)
            tstep=$2
            reading_files=false
	          shift; shift ;;
        -h|--help)
            help ;;
	      *)
            if   [ "$reading_files" = true    ] ; then files+=("$1")
            else
                help
            fi
	          shift ;;
    esac
done

if [ -z $files ]; then
    files=( rsl.out.0000 )
fi

if [ ${width} -lt ${min_width} ]; then
    width=${min_width}
fi

max_flen=4
for out in "${files[@]}"; do
    out_len=$(echo "$out" | wc -m)
    max_flen=$(( $max_flen > $out_len ? $max_flen : $out_len ))
done

printf "| %*s | Comp: Total(s) | Steps | Avg.(s/step) |         Speed | I/O: Total(s) |  Avg.(s/step) |   X |   Y |  CPUs |\n" $max_flen "File"
printf "| %*s +                +       +              +               +               +               +     +     +       |\n" $max_flen " "|
    tr " " "-"

for out in "${files[@]}"; do
    if [ -z "$tstep" ]; then
		    tstep=$( grep -F 'time_step ' namelist.input | cut -d= -f2 | sed -e"s/,/ /g" -e"s/ //g" )
    fi

    offset=
	  if [ -n "${filter}" ]; then
		    offset=$( grep -A3 Writing $out 2>/dev/null | fgrep "Timing for main:" |
                      awk 'BEGIN{i=0;t=0}{i=i+1;t=t+$9}END{printf("-v io=%d -v to=%f",i,t)}' )
	  fi

    printf "| %*s |" $max_flen "$out"
    grep "Timing for main:.*domain  *1" $out 2>/dev/null | tail -n +$filter |
			  awk ${offset} -v s=${tstep} 'BEGIN{t=0;i=0;}{t=t+$9;i=i+1}\
			END{t=t-to;i=i-io;if (i>0) {at=t/i;printf("   %12.5f | %5i | %12.5f | %12.5f  |",t,i,at,s/at)}\
				else {printf("             -- |    -- |           -- |            -- |")}}'
		grep Writing $out 2>/dev/null |
			  awk 'BEGIN{t=0;i=0;}{t=t+$8;i=i+1;}\
			END{if (i>0) {printf("  %12.5f | %12.5f  |",t,t/i)}\
				else {printf("            -- |            -- |")}}'
		grep Ntasks $out 2>/dev/null | sed -e"s/,/ /g" |
			  awk '{x=$4;y=$8;}END{if (NR>0) {printf(" %3i | %3i | %5i |\n",x,y,x*y)}\
				else {printf("  -- |  -- |    -- |\n")}}'

done
