#!/bin/sh

help() {
    echo ""
    echo "Usage: ${0##*/} [-h] [-d DIR] [-t NUM] -w WRF1 WRF2 ... -n X Y Z ... -c CASE1 CASE2 ..."
    echo "Creates and submits a series of PBS jobs scripts for all combinations of parameters"
    echo ""
    echo "OPTIONS:"
    echo "    -r, --rundirs RUN_DIR LIST   Directories of completed wrf_runs to check and summarize."
    echo "    -o, --outdir OUT_DIR         Directory in which to put summary files."
    echo "    -t, --testrst                Also diff wrfrst files."
    echo "    -h, --help                   This help"
    echo ""
    exit 0
}

reading_list=none

while test $# -gt 0
do
    case $1 in
        -r|--rundirs)
            reading_list=rundirs ;;
        -o|--outdir)
            reading_list=none
            OUT_DIR=$2
            shift ;;
        -t|--testrst)
            reading_list=none
            RST=true
            ;;
        -h|--help)
            help ;;
	      *)
            if   [ "$reading_list" = rundirs    ] ; then RUN_DIRS+=("$1")
            else
                help
            fi
	          ;;
    esac
	  shift
done

for DIR in "${RUN_DIRS[@]}"
do
    grep -q "SUCCESS COMPLETE WRF" $DIR/rsl.out.0000
    if [[ $? -ne 0 ]]; then
        echo "rsl.out.0000 in $DIR does not say 'SUCCESS COMPLETE WRF'. stopping..."
        exit 1
    fi

    cmp ${RUN_DIRS[0]}/namelist.input $DIR/namelist.input
    if [[ $? -ne 0 ]]; then
        echo "stopping..."; exit 1
    fi

    for WRFOUT in $(ls ${RUN_DIRS[0]}/wrfout*); do
        WRFOUT=$(basename $WRFOUT)
        cmp ${RUN_DIRS[0]}/$WRFOUT $DIR/$WRFOUT
        if [[ $? -ne 0 ]]; then
            echo "stopping..."; exit 1
        fi
    done
    if [ "$RST" = true ]; then
        for WRFRST in $(ls ${RUN_DIRS[0]}/wrfrst*); do
            WRFRST=$(basename $WRFRST)
            cmp ${RUN_DIRS[0]}/$WRFRST $DIR/$WRFRST
            if [[ $? -ne 0 ]]; then
                echo "stopping..."; exit 1
            fi
        done
    fi
done

mkdir -p $OUT_DIR
cp ${RUN_DIRS[0]}/namelist.input $OUT_DIR
cp ${RUN_DIRS[0]}/wrfout* $OUT_DIR
cp ${RUN_DIRS[0]}/wrfrst* $OUT_DIR

for DIR in "${RUN_DIRS[@]}"
do
    DIR_NAME=$(echo $DIR | sed 's/\//-/g')
    cp $DIR/rsl.out.0000 $OUT_DIR/$DIR_NAME.rsl
done

wrf_stats -t -H -r -f *.rsl -d $OUT_DIR > $OUT_DIR/wrf_stats.tbl
